---
- hosts: localhost
  connection: local

  tasks:
    - name: ensure pre-requisites
      dnf: name={{ item }} state=present
      with_items:
        - libselinux-python
      become: yes

    - name: install common apps
      dnf: name={{ item }} state=present
      with_items:
        - git
        - htop
        - tmux
        - vim-enhanced
      become: yes
      tags: common

    - name: configure Vim
      block:
        - name: ensure Vim directories
          file:
            path: "~/.vim/{{ item }}"
            state: directory
          with_items:
            - autoload
            - backup
            - tmp
            - undodir

        - name: install vim-plug
          get_url:
            url: https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
            dest: ~/.vim/autoload/plug.vim

        - name: configure vim
          blockinfile:
            path: ~/.vimrc
            create: yes
            marker: "\" {mark} {{ item.description }}"
            block: "{{ item.text }}"
          with_items:
            - description: "plugins (vim-plug)"
              text: |
                call plug#begin('~/.vim/plugged')
                Plug 'pearofducks/ansible-vim'
                Plug 'scrooloose/nerdtree', { 'on': 'NERDTreeToggle' }
                call plug#end()
                map <C-n> :NERDTreeToggle<CR>
                autocmd bufenter * if (winnr("$") == 1 && exists("b:NERDTreeType") && b:NERDTreeType == "primary") | q | endif
            - description: "tabs"
              text: |
                set autoindent
                set expandtab
                set shiftwidth=4
                set smarttab
                set softtabstop=4
            - description: "editing"
              text: |
                set history=100
            - description: "search"
              text: |
                set ignorecase
                set incsearch
            - description: "display"
              text: |
                set scrolloff=6
                set cursorline
                set ruler
                set number
                set showcmd
                colorscheme elflord
                " highlight needs to go after colorscheme
                highlight CursorLine term=None cterm=None ctermbg=black
                set colorcolumn=80
            - description: "filetype settings"
              text: |
                autocmd filetype text setlocal textwidth=78
                autocmd filetype python setlocal colorcolumn=90
            - description: "backups"
              text: |
                " Manage backups and swap files in a central location
                " NOTE: vim doesn't create the directories
                set backup
                set backupdir=~/.vim/backup
                set directory=~/.vim/tmp
            - description: "undo"
              text: |
                " Persistent undo.
                " NOTE: vim doesn't create the directories
                set undofile
                set undodir=~/.vim/undodir

      tags:
        - common
        - config
